<h2 class="mb-4">Finalizar compra</h2>

<div class="row">
  <!-- Checkout form -->
  <div class="col-lg-8">
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()">
          <!-- Shipping address -->
          <h5 class="mb-3">Dirección de envío</h5>
          
          <div class="row g-3 mb-4">
            <div class="col-md-6">
              <label for="firstName" class="form-label">Nombre</label>
              <input 
                type="text" 
                formControlName="firstName" 
                class="form-control" 
                [ngClass]="{'is-invalid': submitted && f['firstName'].errors}" 
                id="firstName">
              @if (submitted && f['firstName'].errors) {
                <div class="invalid-feedback">
                  @if (f['firstName'].errors['required']) {
                    El nombre es requerido
                  }
                </div>
              }
            </div>
            
            <div class="col-md-6">
              <label for="lastName" class="form-label">Apellido</label>
              <input 
                type="text" 
                formControlName="lastName" 
                class="form-control" 
                [ngClass]="{'is-invalid': submitted && f['lastName'].errors}" 
                id="lastName">
              @if (submitted && f['lastName'].errors) {
                <div class="invalid-feedback">
                  @if (f['lastName'].errors['required']) {
                    El apellido es requerido
                  }
                </div>
              }
            </div>
            
            <div class="col-12">
              <label for="address" class="form-label">Dirección</label>
              <input 
                type="text" 
                formControlName="address" 
                class="form-control" 
                [ngClass]="{'is-invalid': submitted && f['address'].errors}" 
                id="address">
              @if (submitted && f['address'].errors) {
                <div class="invalid-feedback">
                  @if (f['address'].errors['required']) {
                    La dirección es requerida
                  }
                </div>
              }
            </div>
            
            <div class="col-md-4">
              <label for="city" class="form-label">Ciudad</label>
              <input 
                type="text" 
                formControlName="city" 
                class="form-control" 
                [ngClass]="{'is-invalid': submitted && f['city'].errors}" 
                id="city">
              @if (submitted && f['city'].errors) {
                <div class="invalid-feedback">
                  @if (f['city'].errors['required']) {
                    La ciudad es requerida
                  }
                </div>
              }
            </div>
            
            <div class="col-md-4">
              <label for="state" class="form-label">Provincia</label>
              <input 
                type="text" 
                formControlName="state" 
                class="form-control" 
                [ngClass]="{'is-invalid': submitted && f['state'].errors}" 
                id="state">
              @if (submitted && f['state'].errors) {
                <div class="invalid-feedback">
                  @if (f['state'].errors['required']) {
                    La provincia es requerida
                  }
                </div>
              }
            </div>
            
            <div class="col-md-4">
              <label for="zipCode" class="form-label">Código postal</label>
              <input 
                type="text" 
                formControlName="zipCode" 
                class="form-control" 
                [ngClass]="{'is-invalid': submitted && f['zipCode'].errors}" 
                id="zipCode">
              @if (submitted && f['zipCode'].errors) {
                <div class="invalid-feedback">
                  @if (f['zipCode'].errors['required']) {
                    El código postal es requerido
                  }
                </div>
              }
            </div>
          </div>
          
          <!-- Payment method -->
          <h5 class="mb-3">Método de pago</h5>
          
          <div class="mb-4">
            <div class="form-check mb-2">
              <input 
                class="form-check-input" 
                type="radio" 
                formControlName="paymentMethod" 
                id="creditCard" 
                value="creditCard" 
                checked>
              <label class="form-check-label" for="creditCard">
                <i class="bi bi-credit-card me-2"></i>Tarjeta de crédito
              </label>
            </div>
            
            @if (checkoutForm.get('paymentMethod')?.value === 'creditCard') {
              <div class="card border p-3 mt-2">
                <div class="row g-3">
                  <div class="col-12">
                    <label for="cardName" class="form-label">Nombre en la tarjeta</label>
                    <input 
                      type="text" 
                      formControlName="cardName" 
                      class="form-control" 
                      [ngClass]="{'is-invalid': submitted && f['cardName'].errors}" 
                      id="cardName">
                    @if (submitted && f['cardName'].errors) {
                      <div class="invalid-feedback">
                        @if (f['cardName'].errors['required']) {
                          El nombre en la tarjeta es requerido
                        }
                      </div>
                    }
                  </div>
                  
                  <div class="col-12">
                    <label for="cardNumber" class="form-label">Número de tarjeta</label>
                    <input 
                      type="text" 
                      formControlName="cardNumber" 
                      class="form-control" 
                      [ngClass]="{'is-invalid': submitted && f['cardNumber'].errors}" 
                      id="cardNumber">
                    @if (submitted && f['cardNumber'].errors) {
                      <div class="invalid-feedback">
                        @if (f['cardNumber'].errors['required']) {
                          El número de tarjeta es requerido
                        }
                        @if (f['cardNumber'].errors['pattern']) {
                          El número de tarjeta no es válido
                        }
                      </div>
                    }
                  </div>
                  
                  <div class="col-md-6">
                    <label for="cardExpiry" class="form-label">Fecha de vencimiento (MM/AA)</label>
                    <input 
                      type="text" 
                      formControlName="cardExpiry" 
                      class="form-control" 
                      [ngClass]="{'is-invalid': submitted && f['cardExpiry'].errors}" 
                      id="cardExpiry">
                    @if (submitted && f['cardExpiry'].errors) {
                      <div class="invalid-feedback">
                        @if (f['cardExpiry'].errors['required']) {
                          La fecha de vencimiento es requerida
                        }
                        @if (f['cardExpiry'].errors['pattern']) {
                          Formato inválido
                        }
                      </div>
                    }
                  </div>
                  
                  <div class="col-md-6">
                    <label for="cardCvv" class="form-label">CVV</label>
                    <input 
                      type="text" 
                      formControlName="cardCvv" 
                      class="form-control" 
                      [ngClass]="{'is-invalid': submitted && f['cardCvv'].errors}" 
                      id="cardCvv">
                    @if (submitted && f['cardCvv'].errors) {
                      <div class="invalid-feedback">
                        @if (f['cardCvv'].errors['required']) {
                          El CVV es requerido
                        }
                        @if (f['cardCvv'].errors['pattern']) {
                          El CVV debe tener 3 o 4 dígitos
                        }
                      </div>
                    }
                  </div>
                </div>
              </div>
            }
            
            <div class="form-check mb-2 mt-3">
              <input 
                class="form-check-input" 
                type="radio" 
                formControlName="paymentMethod" 
                id="mercadoPago" 
                value="mercadoPago">
              <label class="form-check-label" for="mercadoPago">
                <i class="bi bi-credit-card-2-front me-2"></i>MercadoPago
              </label>
            </div>
            
            <div class="form-check mb-2">
              <input 
                class="form-check-input" 
                type="radio" 
                formControlName="paymentMethod" 
                id="bankTransfer" 
                value="bankTransfer">
              <label class="form-check-label" for="bankTransfer">
                <i class="bi bi-bank me-2"></i>Transferencia bancaria
              </label>
            </div>
          </div>
          
          <div class="form-check mb-4">
            <input 
              class="form-check-input" 
              type="checkbox" 
              formControlName="termsAccepted"
              [ngClass]="{'is-invalid': submitted && f['termsAccepted'].errors}" 
              id="termsAccepted">
            <label class="form-check-label" for="termsAccepted">
              Acepto los <a href="#" class="text-decoration-none">términos y condiciones</a>
            </label>
            @if (submitted && f['termsAccepted'].errors) {
              <div class="invalid-feedback">
                @if (f['termsAccepted'].errors['required']) {
                  Debe aceptar los términos y condiciones
                }
              </div>
            }
          </div>
          
          <div class="d-flex justify-content-between">
            <a routerLink="/cart" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-2"></i>Volver al carrito
            </a>
            <button type="submit" class="btn btn-primary" [disabled]="loading">
              @if (loading) {
                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              }
              Confirmar pedido
            </button>
          </div>
          
          @if (error) {
            <div class="alert alert-danger mt-3">
              {{ error }}
            </div>
          }
        </form>
      </div>
    </div>
  </div>
  
  <!-- Order summary -->
  <div class="col-lg-4">
    <div class="card shadow-sm sticky-top" style="top: 20px;">
      <div class="card-header bg-white">
        <h5 class="card-title m-0">Resumen del pedido</h5>
      </div>
      <div class="card-body">
        @for (item of cartService.items(); track item.product.id) {
          <div class="d-flex justify-content-between mb-2">
            <span>{{ item.product.name }} × {{ item.quantity }}</span>
            <span>${{ item.product.price * item.quantity | number:'1.2-2' }}</span>
          </div>
        }
        
        <hr>
        
        <div class="d-flex justify-content-between mb-2">
          <span>Subtotal</span>
          <span>${{ cartService.totalAmount() | number:'1.2-2' }}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Impuestos (21%)</span>
          <span>${{ cartService.cartTaxes() | number:'1.2-2' }}</span>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Envío</span>
          <span>$0.00</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between mb-3">
          <span class="fw-bold">Total</span>
          <span class="fw-bold">${{ cartService.cartTotal() | number:'1.2-2' }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Success modal -->
@if (orderSuccess) {
  <div class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background-color: rgba(0,0,0,0.5); z-index: 1050;">
    <div class="card shadow-lg" style="max-width: 500px;">
      <div class="card-body text-center p-5">
        <i class="bi bi-check-circle text-success display-1 mb-4"></i>
        <h3 class="mb-3">¡Pedido realizado con éxito!</h3>
        <p class="mb-4">Tu número de pedido es <strong>#{{ orderNumber }}</strong></p>
        <p class="mb-4">Recibirás un correo electrónico con los detalles de tu pedido.</p>
        <div class="d-grid">
          <button class="btn btn-primary" [routerLink]="['/profile/orders', orderNumber]">
            Ver detalles del pedido
          </button>
        </div>
      </div>
    </div>
  </div>
}